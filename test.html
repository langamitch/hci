<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <!-- QR Scanner Library CDN -->
    <script src="https://unpkg.com/qr-scanner@latest/qr-scanner.min.js"></script>

    <style>
        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem; /* p-4 */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* App Container */
        #app-container {
            width: 100%;
            max-width: 48rem; /* max-w-2xl equivalent */
            background-color: #ffffff; /* bg-white */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 2rem; /* p-8 */
            box-sizing: border-box;
        }

        /* View Section Handling */
        .view-section {
            display: none; /* Hidden by default */
        }

        /* Home View Specifics */
        #home-view {
            text-align: center;
        }
        #home-view h1 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 2rem; /* mb-8 */
        }
        #firebase-status {
            font-size: 1.125rem; /* text-lg */
            color: #4b5563; /* text-gray-600 */
            margin-bottom: 2rem; /* mb-8 */
        }
        #firebase-status.text-red-500 {
            color: #ef4444;
            display: block;
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
        }
        #home-view .flex-col {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* space-y-4 */
            width: 100%;
            max-width: 28rem; /* max-w-sm */
            margin-left: auto; /* mx-auto */
            margin-right: auto; /* mx-auto */
        }

        /* Button Styling (Common for Home, Create, Sign-in views) */
        button {
            width: 100%;
            font-weight: 700; /* font-bold */
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: transform 0.3s ease-in-out; /* transform transition duration-300 ease-in-out */
            cursor: pointer;
            border: none; /* border-transparent */
            outline: none; /* focus:outline-none */
            display: inline-flex; /* inline-flex */
            justify-content: center; /* justify-center */
            align-items: center; /* items-center */
            font-size: 1rem; /* text-base, if needed, adjust individually */
        }
        button:hover {
            transform: scale(1.05); /* hover:scale-105 */
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none; /* Prevent scale on disabled hover */
            box-shadow: none; /* Remove shadow on disabled */
        }

        #create-session-btn {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
        }
        #create-session-btn:hover { background-color: #1d4ed8; /* hover:bg-blue-700 */ }

        #student-sign-in-btn {
            background-color: #16a34a; /* bg-green-600 */
            color: #ffffff; /* text-white */
        }
        #student-sign-in-btn:hover { background-color: #15803d; /* hover:bg-green-700 */ }

        #view-sessions-btn {
            background-color: #7c3aed; /* bg-purple-600 */
            color: #ffffff; /* text-white */
        }
        #view-sessions-btn:hover { background-color: #6d28d9; /* hover:bg-purple-700 */ }

        /* Form Controls (Common) */
        .space-y-4 > div {
            margin-bottom: 1rem; /* space-y-4 */
        }
        .space-y-4 > div:last-child {
            margin-bottom: 0;
        }
        label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="password"] {
            margin-top: 0.25rem; /* mt-1 */
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            outline: none; /* focus:outline-none */
            font-size: 0.875rem; /* sm:text-sm */
        }
        input:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 1px #3b82f6; /* focus:ring-blue-500 */
        }

        /* Message Box Styling (Common) */
        .message-box {
            border-radius: 0.375rem; /* rounded-md */
            padding: 1rem; /* p-4 */
            position: relative;
            margin-top: 1rem; /* mt-4 */
        }
        .message-box.success {
            background-color: #d4edda; /* bg-green-100 */
            border: 1px solid #c3e6cb; /* border-green-400 */
            color: #155724; /* text-green-700 */
        }
        .message-box.error {
            background-color: #f8d7da; /* bg-red-100 */
            border: 1px solid #f5c6cb; /* border-red-400 */
            color: #721c24; /* text-red-700 */
        }
        .message-box .close-btn {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            padding: 1rem;
            cursor: pointer;
        }
        .message-box .close-btn svg {
            fill: currentColor;
            height: 1.5rem; /* h-6 */
            width: 1.5rem; /* w-6 */
        }

        /* OR Divider */
        .or-divider {
            text-align: center;
            margin: 1.25rem 0; /* 20px */
            font-weight: 700; /* font-bold */
            color: #4b5563; /* text-gray-600 */
            position: relative;
        }
        .or-divider::before, .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #d1d5db; /* #ddd */
        }
        .or-divider::before {
            left: 0;
        }
        .or-divider::after {
            right: 0;
        }

        /* Specific Buttons for forms */
        #get-location-create-btn, #start-qr-scanner-btn {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        #get-location-create-btn:hover, #start-qr-scanner-btn:hover { background-color: #1d4ed8; /* hover:bg-blue-700 */ }

        #submit-create-session, #submit-sign-in {
            background-color: #16a34a; /* bg-green-600 */
            color: #ffffff; /* text-white */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        #submit-create-session:hover, #submit-sign-in:hover { background-color: #15803d; /* hover:bg-green-700 */ }

        /* Back Home Buttons */
        #back-home-create-btn, #back-home-sign-in-btn, #back-home-view-btn {
            background: none;
            border: none;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #2563eb; /* text-blue-600 */
            text-align: left;
            margin-top: 1.5rem; /* mt-6 */
            box-shadow: none; /* No shadow */
        }
        #back-home-create-btn:hover, #back-home-sign-in-btn:hover, #back-home-view-btn:hover {
            color: #1d4ed8; /* hover:text-blue-800 */
            transform: none; /* No scale on hover */
        }

        /* QR Code Display */
        #created-pin-display {
            margin-top: 1.5rem; /* mt-6 */
            padding: 1rem; /* p-4 */
            border: 1px dashed #d1d5db; /* border border-dashed border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: center;
        }
        #created-pin-display p.font-semibold {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #created-pin-display span.text-green-600 {
            color: #16a34a; /* text-green-600 */
        }
        #created-pin-display p.text-sm {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #qr-code-img {
            margin-left: auto; /* mx-auto */
            margin-right: auto; /* mx-auto */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
        }

        /* Sign-in View Specifics */
        .border-dashed {
            border-style: dashed;
            border-color: #d1d5db; /* border-gray-300 */
            padding: 1rem; /* p-4 */
            border-radius: 0.375rem; /* rounded-md */
        }
        #sign-in-pin + p, #start-qr-scanner-btn + input + p {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.25rem; /* mt-1 */
        }
        #qr-video-scanner {
            margin-top: 0.25rem; /* mt-1 */
            display: block;
            width: 100%;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #000000; /* background-color: #000 */
            min-height: 9.375rem; /* min-height: 150px */
        }
        #qr-scan-status {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
            margin-top: 0.5rem; /* mt-2 */
        }
        #qr-scan-status.text-green-600 {
            color: #16a34a; /* text-green-600 */
        }
        #student-location-status {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
            font-style: italic;
        }

        /* View Sessions View Specifics */
        #sessions-list > div {
            padding: 1rem; /* p-4 */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
        }
        #sessions-list > div:hover {
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        #sessions-list > div.border-blue-500 {
            border-color: #3b82f6; /* border-blue-500 */
            background-color: #eff6ff; /* bg-blue-50 */
        }
        #sessions-list h3 {
            font-weight: 600; /* font-semibold */
            font-size: 1.125rem; /* text-lg */
        }
        #sessions-list h3 span.text-gray-500 {
            color: #6b7280; /* text-gray-500 */
            font-size: 0.875rem; /* text-sm */
        }
        #sessions-list p.font-mono {
            font-family: monospace;
            color: #2563eb; /* text-blue-700 */
        }
        #sessions-list p.text-xs {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
        }
        #selected-session-records {
            margin-top: 2rem; /* mt-8 */
            border-top: 1px solid #e5e7eb; /* border-t */
            padding-top: 1.5rem; /* pt-6 */
        }
        #selected-session-records h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 1rem; /* mb-4 */
            color: #1a202c; /* text-gray-800 */
        }
        #attendance-records-list li {
            padding-top: 0.75rem; /* py-3 */
            padding-bottom: 0.75rem; /* py-3 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb; /* divide-y divide-gray-200 */
        }
        #attendance-records-list li:last-child {
            border-bottom: none;
        }
        #attendance-records-list p.font-medium {
            font-weight: 500; /* font-medium */
            font-size: 1.125rem; /* text-lg */
            color: #1a202c; /* text-gray-900 */
        }
        #attendance-records-list p.text-sm {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-2xl bg-white rounded-lg shadow-xl p-8">

        <!-- Home View -->
        <div id="home-view" class="view-section text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-8">Attendance System</h1>
            <p id="firebase-status" class="text-lg text-gray-600 mb-8"></p>
            <div class="flex-col">
                <button id="create-session-btn">
                    Create New Attendance Session
                </button>
                <button id="student-sign-in-btn">
                    Student Sign-in
                </button>
                <button id="view-sessions-btn">
                    View My Attendance Sessions
                </button>
            </div>
        </div>

        <!-- Create Attendance Session View -->
        <div id="create-view" class="view-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Create Attendance Session</h2>
            <form id="create-session-form" class="space-y-4">
                <div>
                    <label for="create-session-name">Session Name</label>
                    <input type="text" id="create-session-name" placeholder="e.g., Math Class Q3" required>
                </div>
                <div>
                    <label for="create-class-date">Class Date</label>
                    <input type="date" id="create-class-date" required>
                </div>
                <div>
                    <label>Attendance Point Location</label>
                    <p id="create-location-status">Click "Get Location" to set attendance point.</p>
                    <button type="button" id="get-location-create-btn">
                        Get Location
                    </button>
                    <input type="hidden" id="create-lat">
                    <input type="hidden" id="create-lon">
                </div>
                <button type="submit" id="submit-create-session">
                    Generate PIN & Create Session
                </button>
            </form>

            <div id="created-pin-display" class="hidden">
                <p>Generated PIN: <span id="generated-pin"></span></p>
                <p>Share this PIN or QR code with students.</p>
                <img id="qr-code-img" src="https://placehold.co/150x150/EEEEEE/CCCCCC?text=QR+Code" alt="QR Code" onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEEEEE/CCCCCC?text=QR+Error';"/>
            </div>
            <div id="create-message-container"></div>
            <button id="back-home-create-btn">
                ← Back to Home
            </button>
        </div>

        <!-- Student Sign-in View -->
        <div id="sign-in-view" class="view-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Student Sign-in</h2>
            <form id="sign-in-form" class="space-y-4">
                <div>
                    <label for="student-name">Your Name</label>
                    <input type="text" id="student-name" placeholder="Your Full Name" required>
                </div>
                <div>
                    <label for="student-email">Your Email</label>
                    <input type="email" id="student-email" placeholder="your.email@example.com" required>
                </div>

                <div class="border-dashed">
                    <label for="sign-in-pin">Enter PIN (6-digits)</label>
                    <input type="password" id="sign-in-pin" maxlength="6" placeholder="XXXXXX">
                    <p>Enter PIN if QR code scanning is not available.</p>
                </div>

                <div class="or-divider">OR</div>

                <div class="border-dashed">
                    <label>Scan QR Code</label>
                    <video id="qr-video-scanner" style="display:none;" autoplay playsinline></video>
                    <button type="button" id="start-qr-scanner-btn">
                        Start Camera for QR
                    </button>
                    <input type="hidden" id="scanned-qr-value">
                    <p id="qr-scan-status">No QR code scanned yet.</p>
                    <p>Scanned QR data will populate automatically.</p>
                </div>

                <div class="mt-6">
                    <label>Your Current Location</label>
                    <p id="student-location-status">Detecting your location...</p>
                </div>

                <button type="submit" id="submit-sign-in">
                    Submit Attendance
                </button>
            </form>
            <div id="sign-in-message-container"></div>
            <button id="back-home-sign-in-btn">
                ← Back to Home
            </button>
        </div>

        <!-- View Attendance Sessions View -->
        <div id="view-sessions-view" class="view-section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">My Attendance Sessions</h2>
            <div id="sessions-list">
                <p>Loading sessions...</p>
            </div>

            <div id="selected-session-records" class="hidden">
                <h3 id="records-for-session-title"></h3>
                <ul id="attendance-records-list">
                    <p>No students have signed in for this session yet.</p>
                </ul>
            </div>
            <div id="view-message-container"></div>
            <button id="back-home-view-btn">
                ← Back to Home
            </button>
        </div>

    </div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for use in the main script
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.firebaseLoading = true;
        window.firebaseError = null;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Global Variables and DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const homeView = document.getElementById('home-view');
        const createView = document.getElementById('create-view');
        const signInView = document.getElementById('sign-in-view');
        const viewSessionsView = document.getElementById('view-sessions-view');

        // Home Buttons
        const createSessionBtn = document.getElementById('create-session-btn');
        const studentSignInBtn = document.getElementById('student-sign-in-btn');
        const viewSessionsBtn = document.getElementById('view-sessions-btn');
        const firebaseStatusElement = document.getElementById('firebase-status');

        // Create Session Elements
        const createSessionForm = document.getElementById('create-session-form');
        const createSessionNameInput = document.getElementById('create-session-name');
        const createClassDateInput = document.getElementById('create-class-date');
        const getLocationCreateBtn = document.getElementById('get-location-create-btn');
        const createLocationStatus = document.getElementById('create-location-status');
        const createLatInput = document.getElementById('create-lat');
        const createLonInput = document.getElementById('create-lon');
        const submitCreateSessionBtn = document.getElementById('submit-create-session');
        const createdPinDisplay = document.getElementById('created-pin-display');
        const generatedPinSpan = document.getElementById('generated-pin');
        const qrCodeImg = document.getElementById('qr-code-img');
        const backHomeCreateBtn = document.getElementById('back-home-create-btn');
        const createMessageContainer = document.getElementById('create-message-container');

        // Student Sign-in Elements
        const signInForm = document.getElementById('sign-in-form');
        const studentNameInput = document.getElementById('student-name');
        const studentEmailInput = document.getElementById('student-email');
        const signInPinInput = document.getElementById('sign-in-pin');
        const qrVideoScanner = document.getElementById('qr-video-scanner');
        const startQrScannerBtn = document.getElementById('start-qr-scanner-btn');
        const scannedQrValueInput = document.getElementById('scanned-qr-value');
        const qrScanStatus = document.getElementById('qr-scan-status');
        const studentLocationStatus = document.getElementById('student-location-status');
        const submitSignInBtn = document.getElementById('submit-sign-in');
        const signInMessageContainer = document.getElementById('sign-in-message-container');
        const backHomeSignInBtn = document.getElementById('back-home-sign-in-btn');

        // View Sessions Elements
        const sessionsList = document.getElementById('sessions-list');
        const selectedSessionRecordsDiv = document.getElementById('selected-session-records');
        const recordsForSessionTitle = document.getElementById('records-for-session-title');
        const attendanceRecordsList = document.getElementById('attendance-records-list');
        const viewMessageContainer = document.getElementById('view-message-container');
        const backHomeViewBtn = document.getElementById('back-home-view-btn');

        // State variables (JavaScript equivalents for React state)
        let currentView = 'home';
        let sessionCreationLocation = null; // {latitude, longitude} for create view
        let studentCurrentLocation = null;  // {latitude, longitude} for sign-in view
        let isStudentLocationObtained = false;
        let qrScannerInstance = null; // Holds the QrScanner object
        let cameraStreamInstance = null; // Holds the MediaStream object
        let selectedSessionIdToView = null; // For View Sessions component

        // Constants
        const PROXIMITY_RADIUS_METERS = 5;
        // Placeholder for attendance session location (for comparison)
        // **IMPORTANT:** In a real app, this location should come from the session data fetched from Firebase.
        const PLACEHOLDER_ATTENDANCE_POINT = { latitude: -33.0069, longitude: 27.8285 }; // Example: East London

        // --- Utility Functions ---

        /**
         * Haversine formula to calculate distance between two lat/lon points.
         * @param {number} lat1 Latitude of point 1
         * @param {number} lon1 Longitude of point 1
         * @param {number} lat2 Latitude of point 2
         * @param {number} lon2 Longitude of point 2
         * @returns {number} Distance in meters
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // in metres
            return d;
        }

        /**
         * Generates a random 6-digit PIN.
         * @returns {string} 6-digit PIN
         */
        function generatePin() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        /**
         * Displays a message in a designated container.
         * @param {HTMLElement} container The DOM element to append the message to.
         * @param {string} type 'success' or 'error'.
         * @param {string} message The message text.
         */
        function showMessageBox(container, type, message) {
            // Clear any existing messages first
            container.innerHTML = '';

            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}`; /* Removed mt-4 from here, add via margin style below */
            messageBox.style.marginTop = '1rem'; /* mt-4 */
            messageBox.role = 'alert';
            messageBox.innerHTML = `
                <strong class="font-bold">${type === 'success' ? 'Success!' : 'Error!'}</strong>
                <span class="block sm:inline ml-2">${message}</span>
                <span class="close-btn">
                    <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.196l-2.651 2.652a1.2 1.2 0 1 1-1.697-1.697L8.303 9.5l-2.651-2.651a1.2 1.2 0 1 1 1.697-1.697L10 7.803l2.651-2.651a1.2 1.2 0 0 1 1.697 1.697L11.696 9.5l2.652 2.651a1.2 1.2 0 0 1 0 1.698z"/></svg>
                </span>
            `;
            container.appendChild(messageBox);

            messageBox.querySelector('.close-btn').addEventListener('click', () => {
                messageBox.remove();
            });

            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageBox.remove();
                }, 5000);
            }
        }

        /**
         * Hides all view sections.
         */
        function hideAllViews() {
            document.querySelectorAll('.view-section').forEach(section => {
                section.style.display = 'none';
            });
        }

        /**
         * Shows a specific view section and hides others.
         * @param {string} viewName The ID of the view section to show (e.g., 'home', 'create-view', 'sign-in-view', 'view-sessions-view').
         */
        function showView(viewName) {
            hideAllViews();
            currentView = viewName;

            // Reset specific view states before showing
            if (viewName === 'create-view') {
                createSessionForm.reset();
                createdPinDisplay.classList.add('hidden');
                createLocationStatus.textContent = 'Click "Get Location" to set attendance point.';
                sessionCreationLocation = null;
                createMessageContainer.innerHTML = '';
            } else if (viewName === 'sign-in-view') {
                signInForm.reset();
                scannedQrValueInput.value = '';
                qrScanStatus.textContent = 'No QR code scanned yet.';
                signInPinInput.disabled = false;
                startQrScannerBtn.textContent = 'Start Camera for QR';
                startQrScannerBtn.disabled = false;
                qrVideoScanner.style.display = 'none';
                signInMessageContainer.innerHTML = '';
                if (qrScannerInstance) {
                    qrScannerInstance.stop();
                    qrScannerInstance.destroy();
                    qrScannerInstance = null;
                }
                if (cameraStreamInstance) {
                    cameraStreamInstance.getTracks().forEach(track => track.stop());
                    cameraStreamInstance = null;
                }
                // Automatically attempt to get student location on sign-in view load
                getStudentLocation();
            } else if (viewName === 'view-sessions-view') {
                selectedSessionIdToView = null;
                selectedSessionRecordsDiv.classList.add('hidden');
                attendanceRecordsList.innerHTML = '<p>No students have signed in for this session yet.</p>';
                sessionsList.innerHTML = '<p>Loading sessions...</p>';
                viewMessageContainer.innerHTML = '';
                fetchAttendanceSessions(); // Fetch sessions when view is shown
            }

            document.getElementById(viewName).style.display = 'block';
        }

        // Function to update Firebase status on the UI (e.g., on the Home screen)
        function updateFirebaseStatusUI() {
            if (firebaseStatusElement) {
                if (window.firebaseLoading) {
                    firebaseStatusElement.textContent = `Loading Firebase...`;
                    firebaseStatusElement.style.fontSize = '1.125rem'; /* text-lg */
                    firebaseStatusElement.style.color = '#4b5563'; /* text-gray-600 */
                    firebaseStatusElement.style.marginBottom = '2rem'; /* mb-8 */
                    firebaseStatusElement.style.textAlign = 'center'; /* text-center */
                } else if (window.firebaseError) {
                    firebaseStatusElement.textContent = `Error: ${window.firebaseError}`;
                    firebaseStatusElement.style.color = '#ef4444'; /* text-red-500 */
                    firebaseStatusElement.style.display = 'block';
                    firebaseStatusElement.style.fontSize = '0.875rem'; /* text-sm */
                    firebaseStatusElement.style.marginTop = '0.5rem'; /* mt-2 */
                } else {
                    firebaseStatusElement.textContent = `Welcome, User ID: ${window.currentUserId}`;
                    firebaseStatusElement.style.fontSize = '1.125rem'; /* text-lg */
                    firebaseStatusElement.style.color = '#4b5563'; /* text-gray-600 */
                    firebaseStatusElement.style.marginBottom = '2rem'; /* mb-8 */
                    firebaseStatusElement.style.textAlign = 'center'; /* text-center */
                }
            }

            // Also manage button disabled states
            const homeButtons = document.querySelectorAll('#home-view button');
            homeButtons.forEach(button => {
                button.disabled = window.firebaseLoading || !!window.firebaseError;
            });
        }


        // --- Geolocation Function (used by both create and sign-in) ---
        /**
         * Attempts to get the current geolocation.
         * @param {function(object): void} successCallback Function to call on success.
         * @param {function(object): void} errorCallback Function to call on error.
         * @param {HTMLElement} statusElement DOM element to update status text.
         * @param {HTMLElement} messageContainer DOM element to show error messages.
         */
        function getCurrentGeolocation(successCallback, errorCallback, statusElement, messageContainer) {
            statusElement.textContent = 'Requesting location...';
            messageContainer.innerHTML = ''; // Clear previous messages

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        successCallback(position);
                    },
                    (error) => {
                        let msg = "Could not detect your location.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                msg += " **Please enable location services for this site in your browser settings (e.g., Safari/Chrome Site Settings), and ensure location access is allowed for your browser in your device's Privacy & Security settings.**";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                msg += " Location information is unavailable. Check your device's GPS/Wi-Fi.";
                                break;
                            case error.TIMEOUT:
                                msg += " Timed out while trying to get your location.";
                                break;
                            case error.UNKNOWN_ERROR:
                                msg += " An unknown error occurred.";
                                break;
                        }
                        statusElement.textContent = `Location Error: ${msg}`;
                        showMessageBox(messageContainer, 'error', msg);
                        errorCallback(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                const msg = "Geolocation is not supported by your browser. Please use a modern browser.";
                statusElement.textContent = msg;
                showMessageBox(messageContainer, 'error', msg);
                errorCallback(new Error(msg));
            }
        }

        // --- Create Attendance Session Logic ---

        let createViewLocation = null; // Local variable for location in create view

        getLocationCreateBtn.addEventListener('click', () => {
            getCurrentGeolocation(
                (position) => {
                    createViewLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    };
                    createLatInput.value = position.coords.latitude;
                    createLonInput.value = position.coords.longitude;
                    createLocationStatus.textContent = `Location set: Lat ${position.coords.latitude.toFixed(4)}, Lon ${position.coords.longitude.toFixed(4)}`;
                    showMessageBox(createMessageContainer, 'success', 'Location successfully captured!');
                },
                (error) => {
                    createViewLocation = null;
                    createLatInput.value = '';
                    createLonInput.value = '';
                    createLocationStatus.textContent = 'Location not set.';
                },
                createLocationStatus,
                createMessageContainer
            );
        });

        createSessionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessageBox(createMessageContainer, 'success', ''); // Clear previous messages
            showMessageBox(createMessageContainer, 'error', '');

            const sessionName = createSessionNameInput.value.trim();
            const classDate = createClassDateInput.value.trim();

            if (!sessionName || !classDate) {
                showMessageBox(createMessageContainer, 'error', 'Please fill in session name and date.');
                return;
            }
            if (!createViewLocation) {
                showMessageBox(createMessageContainer, 'error', 'Please get the location for the attendance point.');
                return;
            }
            if (window.firebaseLoading || !window.db || !window.currentUserId) {
                showMessageBox(createMessageContainer, 'error', window.firebaseError || 'Firebase not initialized or user not authenticated. Please wait.');
                return;
            }

            submitCreateSessionBtn.disabled = true;
            submitCreateSessionBtn.textContent = 'Creating...';

            const generatedPin = generatePin();
            const sessionData = {
                sessionId: `session_${Date.now()}_${window.currentUserId}`, // Unique ID for the session
                name: sessionName,
                date: classDate,
                pin: generatedPin,
                location: createViewLocation,
                creatorId: window.currentUserId,
                createdAt: new Date().toISOString(),
            };

            try {
                // Store in public collection for easier student lookup
                const allAttendanceSessionsRef = collection(window.db, `artifacts/${__app_id}/public/data/allAttendanceSessions`);
                await addDoc(allAttendanceSessionsRef, sessionData);

                generatedPinSpan.textContent = generatedPin;
                qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${generatedPin}`;
                createdPinDisplay.classList.remove('hidden');

                showMessageBox(createMessageContainer, 'success', 'Attendance session created successfully!');
                createSessionForm.reset();
                createLocationStatus.textContent = 'Click "Get Location" to set attendance point.';
                sessionCreationLocation = null; // Reset location for next session
            } catch (e) {
                console.error("Error creating session:", e);
                showMessageBox(createMessageContainer, 'error', `Failed to create session: ${e.message}`);
                createdPinDisplay.classList.add('hidden'); // Hide PIN if creation fails
            } finally {
                submitCreateSessionBtn.disabled = false;
                submitCreateSessionBtn.textContent = 'Generate PIN & Create Session';
            }
        });

        // --- Student Sign-in Logic ---

        // Auto-detect student location when the sign-in view is shown
        function getStudentLocation() {
            getCurrentGeolocation(
                (position) => {
                    studentCurrentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    };
                    isStudentLocationObtained = true;
                    studentLocationStatus.textContent = `Location detected. (Lat: ${position.coords.latitude.toFixed(4)}, Lon: ${position.coords.longitude.toFixed(4)})`;
                },
                (error) => {
                    studentCurrentLocation = null;
                    isStudentLocationObtained = false;
                    // Error message handled by getCurrentGeolocation
                },
                studentLocationStatus,
                signInMessageContainer
            );
        }

        // QR Scanner Initialization
        startQrScannerBtn.addEventListener('click', async () => {
            if (qrScannerInstance) {
                qrScannerInstance.stop();
                qrScannerInstance.destroy();
                qrScannerInstance = null;
            }
            if (cameraStreamInstance) {
                cameraStreamInstance.getTracks().forEach(track => track.stop());
                cameraStreamInstance = null;
            }
            showMessageBox(signInMessageContainer, 'error', ''); // Clear previous errors

            startQrScannerBtn.textContent = 'Requesting Camera...';
            startQrScannerBtn.disabled = true;
            qrVideoScanner.style.display = 'none'; // Hide video until stream is ready

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                qrVideoScanner.srcObject = stream;
                cameraStreamInstance = stream;
                qrVideoScanner.style.display = 'block'; // Show video

                qrScannerInstance = new QrScanner(
                    qrVideoScanner,
                    result => {
                        console.log('Scanned QR Code:', result.data);
                        scannedQrValueInput.value = result.data;
                        qrScanStatus.textContent = `QR Scanned: ${result.data.substring(0, 20)}...`;
                        signInPinInput.value = ''; // Clear PIN field if QR is scanned
                        signInPinInput.disabled = true; // Disable PIN input

                        showMessageBox(signInMessageContainer, 'success', 'QR Code scanned successfully! Proceed to submit.');

                        if (qrScannerInstance) {
                            qrScannerInstance.stop();
                            qrScannerInstance.destroy();
                            qrScannerInstance = null;
                        }
                        if (cameraStreamInstance) {
                            cameraStreamInstance.getTracks().forEach(track => track.stop());
                            cameraStreamInstance = null;
                        }
                        qrVideoScanner.style.display = 'none'; // Hide video after scan
                        startQrScannerBtn.textContent = 'Start Camera for QR';
                        startQrScannerBtn.disabled = false;
                    },
                    { highlightScanRegion: true, highlightCodeOutline: true }
                );
                await qrScannerInstance.start();
                startQrScannerBtn.textContent = 'Scanning...';
            } catch (error) {
                console.error("Error accessing camera: ", error);
                const msg = "Camera access denied or unavailable. Please ensure your browser and device have camera permissions.";
                qrScanStatus.textContent = `QR Error: ${msg}`;
                showMessageBox(signInMessageContainer, 'error', msg);
                qrVideoScanner.srcObject = null;
                qrVideoScanner.style.display = 'none';
                startQrScannerBtn.textContent = 'Start Camera for QR';
                startQrScannerBtn.disabled = false;
            }
        });

        // Handle PIN input change to clear QR code field and stop scanner
        signInPinInput.addEventListener('input', () => {
            if (signInPinInput.value.trim() !== '') {
                scannedQrValueInput.value = ''; // Clear QR value
                qrScanStatus.textContent = 'Using PIN instead of QR.';
                if (qrScannerInstance) {
                    qrScannerInstance.stop();
                    qrScannerInstance.destroy();
                    qrScannerInstance = null;
                }
                if (cameraStreamInstance) {
                    cameraStreamInstance.getTracks().forEach(track => track.stop());
                    cameraStreamInstance = null;
                }
                qrVideoScanner.style.display = 'none';
                startQrScannerBtn.textContent = 'Start Camera for QR';
                startQrScannerBtn.disabled = false; // Re-enable QR button
            } else {
                qrScanStatus.textContent = 'No QR code scanned yet.';
                signInPinInput.disabled = false; // Ensure PIN input is enabled if cleared
            }
        });

        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessageBox(signInMessageContainer, 'success', ''); // Clear previous messages
            showMessageBox(signInMessageContainer, 'error', '');

            const studentName = studentNameInput.value.trim();
            const studentEmail = studentEmailInput.value.trim();
            const enteredPin = signInPinInput.value.trim();
            const scannedQr = scannedQrValueInput.value.trim();

            if (!studentName || !studentEmail) {
                showMessageBox(signInMessageContainer, 'error', 'Please enter your name and email.');
                return;
            }
            if (!enteredPin && !scannedQr) {
                showMessageBox(signInMessageContainer, 'error', 'Please enter a PIN or scan a QR code.');
                return;
            }
            if (enteredPin && scannedQr) {
                showMessageBox(signInMessageContainer, 'error', 'Please use EITHER a PIN OR scan a QR code, not both.');
                return;
            }
            if (!isStudentLocationObtained || !studentCurrentLocation) {
                showMessageBox(signInMessageContainer, 'error', 'Location not detected. Please ensure location services are enabled for this site and try again.');
                getStudentLocation(); // Attempt to re-get location
                return;
            }
            if (window.firebaseLoading || !window.db || !window.currentUserId) {
                showMessageBox(signInMessageContainer, 'error', window.firebaseError || 'Firebase not initialized or user not authenticated. Please wait.');
                return;
            }

            submitSignInBtn.disabled = true;
            submitSignInBtn.textContent = 'Submitting...';

            const authenticationValue = enteredPin || scannedQr;

            try {
                // 1. Look up the attendance session by PIN from the public sessions collection
                const allAttendanceSessionsRef = collection(window.db, `artifacts/${__app_id}/public/data/allAttendanceSessions`);
                const qAll = query(allAttendanceSessionsRef, where("pin", "==", authenticationValue));
                const querySnapshotAll = await getDocs(qAll);

                if (querySnapshotAll.empty) {
                    showMessageBox(signInMessageContainer, 'error', 'Invalid PIN or QR Code. No active session found with this code.');
                    submitSignInBtn.disabled = false;
                    submitSignInBtn.textContent = 'Submit Attendance';
                    return;
                }

                const sessionDoc = querySnapshotAll.docs[0]; // Get the first matching session
                const sessionData = sessionDoc.data();
                const attendancePointLocation = sessionData.location;

                // 2. Compare locations
                const distance = calculateDistance(
                    studentCurrentLocation.latitude,
                    studentCurrentLocation.longitude,
                    attendancePointLocation.latitude,
                    attendancePointLocation.longitude
                );

                if (distance > PROXIMITY_RADIUS_METERS) {
                    showMessageBox(signInMessageContainer, 'error', `You are too far from the attendance point. Distance: ${distance.toFixed(2)} meters (Allowed: ${PROXIMITY_RADIUS_METERS} m)`);
                    submitSignInBtn.disabled = false;
                    submitSignInBtn.textContent = 'Submit Attendance';
                    return;
                }

                // 3. Record attendance
                const attendanceRecord = {
                    sessionId: sessionData.sessionId,
                    sessionName: sessionData.name,
                    classDate: sessionData.date,
                    studentName: studentName,
                    studentEmail: studentEmail,
                    studentLocation: studentCurrentLocation,
                    distanceToPoint: distance.toFixed(2),
                    signedAt: new Date().toISOString(),
                    creatorId: sessionData.creatorId, // Link to the creator of the session
                };

                const attendanceRecordsRef = collection(window.db, `artifacts/${__app_id}/public/data/attendanceRecords`);
                await addDoc(attendanceRecordsRef, attendanceRecord);

                showMessageBox(signInMessageContainer, 'success', 'Attendance submitted successfully!');
                signInForm.reset();
                scannedQrValueInput.value = '';
                signInPinInput.disabled = false;
                qrScanStatus.textContent = 'No QR code scanned yet.';
                getStudentLocation(); // Re-initiate location check for next submission
            } catch (e) {
                console.error("Error submitting attendance:", e);
                showMessageBox(signInMessageContainer, 'error', `Failed to submit attendance: ${e.message}`);
            } finally {
                submitSignInBtn.disabled = false;
                submitSignInBtn.textContent = 'Submit Attendance';
            }
        });

        // --- View Attendance Sessions Logic ---

        async function fetchAttendanceSessions() {
            sessionsList.innerHTML = '<p class="text-gray-600">Loading sessions...</p>';
            viewMessageContainer.innerHTML = '';
            if (window.firebaseLoading || !window.db || !window.currentUserId) {
                showMessageBox(viewMessageContainer, 'error', window.firebaseError || 'Firebase not initialized or user not authenticated. Cannot load sessions.');
                sessionsList.innerHTML = '<p class="text-red-600">Error loading sessions.</p>';
                return;
            }

            try {
                // Fetch sessions created by the current user from the public collection
                const allAttendanceSessionsRef = collection(window.db, `artifacts/${__app_id}/public/data/allAttendanceSessions`);
                const q = query(allAttendanceSessionsRef, where("creatorId", "==", window.currentUserId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        sessionsList.innerHTML = '<p class="text-gray-600">No attendance sessions created yet.</p>';
                        return;
                    }
                    sessionsList.innerHTML = ''; // Clear previous list
                    snapshot.docs.forEach(doc => {
                        const session = { id: doc.id, ...doc.data() };
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'session-item'; /* Custom class for session items */
                        sessionDiv.innerHTML = `
                            <h3>${session.name} <span>(${session.date})</span></h3>
                            <p>PIN: <span>${session.pin}</span></p>
                            <p>Created: ${new Date(session.createdAt).toLocaleString()}</p>
                            <p>Attendance Point: Lat ${session.location.latitude.toFixed(4)}, Lon ${session.location.longitude.toFixed(4)}</p>
                        `;
                        sessionDiv.addEventListener('click', () => {
                            // Visually highlight selected session
                            document.querySelectorAll('#sessions-list .session-item').forEach(div => {
                                div.classList.remove('selected-session');
                            });
                            sessionDiv.classList.add('selected-session');

                            selectedSessionIdToView = session.sessionId;
                            fetchAttendanceRecords(session.sessionId, session.name);
                        });
                        sessionsList.appendChild(sessionDiv);
                    });
                }, (error) => {
                    console.error("Error fetching sessions:", error);
                    showMessageBox(viewMessageContainer, 'error', `Failed to load sessions: ${error.message}`);
                    sessionsList.innerHTML = '<p class="text-red-600">Error loading sessions.</p>';
                });
            } catch (e) {
                console.error("Error fetching sessions init:", e);
                showMessageBox(viewMessageContainer, 'error', `Failed to initialize session fetching: ${e.message}`);
            }
        }

        async function fetchAttendanceRecords(sessionId, sessionName) {
            recordsForSessionTitle.textContent = `Attendance Records for "${sessionName}"`;
            attendanceRecordsList.innerHTML = '<p>Loading records...</p>';
            selectedSessionRecordsDiv.classList.remove('hidden');
            viewMessageContainer.innerHTML = '';

            if (window.firebaseLoading || !window.db) {
                showMessageBox(viewMessageContainer, 'error', window.firebaseError || 'Firebase not initialized. Cannot load records.');
                attendanceRecordsList.innerHTML = '<p class="text-red-600">Error loading records.</p>';
                return;
            }

            try {
                const attendanceRecordsRef = collection(window.db, `artifacts/${__app_id}/public/data/attendanceRecords`);
                const q = query(attendanceRecordsRef, where("sessionId", "==", sessionId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        attendanceRecordsList.innerHTML = '<p>No students have signed in for this session yet.</p>';
                        return;
                    }
                    attendanceRecordsList.innerHTML = ''; // Clear previous records
                    snapshot.docs.forEach(doc => {
                        const record = doc.data();
                        const listItem = document.createElement('li');
                        listItem.className = 'record-item'; /* Custom class for record items */
                        listItem.innerHTML = `
                            <div>
                                <p>${record.studentName}</p>
                                <p>${record.studentEmail}</p>
                                <p>Signed at: ${new Date(record.signedAt).toLocaleString()}</p>
                                <p>Location: Lat ${record.studentLocation.latitude.toFixed(4)}, Lon ${record.studentLocation.longitude.toFixed(4)}</p>
                                <p>Distance to Point: ${record.distanceToPoint} meters</p>
                            </div>
                        `;
                        attendanceRecordsList.appendChild(listItem);
                    });
                }, (error) => {
                    console.error("Error fetching attendance records:", error);
                    showMessageBox(viewMessageContainer, 'error', `Failed to load attendance records: ${error.message}`);
                    attendanceRecordsList.innerHTML = '<p class="text-red-600">Error loading records.</p>';
                });
            } catch (e) {
                console.error("Error fetching records init:", e);
                showMessageBox(viewMessageContainer, 'error', `Failed to initialize record fetching: ${e.message}`);
            }
        }

        // --- Event Listeners for Navigation ---
        createSessionBtn.addEventListener('click', () => showView('create-view'));
        studentSignInBtn.addEventListener('click', () => showView('sign-in-view'));
        viewSessionsBtn.addEventListener('click', () => showView('view-sessions-view'));

        backHomeCreateBtn.addEventListener('click', () => showView('home'));
        backHomeSignInBtn.addEventListener('click', () => showView('home'));
        backHomeViewBtn.addEventListener('click', () => showView('home'));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Set initial date for create session form to today
            createClassDateInput.value = new Date().toISOString().slice(0, 10);

            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                window.firebaseApp = app;
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // Sign in anonymously or with custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("Firebase initialized. User ID:", window.currentUserId);
                    } else {
                        window.currentUserId = null;
                        console.log("Firebase: User signed out.");
                    }
                    window.firebaseLoading = false;
                    updateFirebaseStatusUI();
                    showView('home'); // Show home view after Firebase is ready
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                window.firebaseError = "Failed to initialize Firebase: " + e.message;
                window.firebaseLoading = false;
                updateFirebaseStatusUI();
                showView('home'); // Still show home view, but with error
            }
        });

    </script>
</body>
</html>
